## **Пример использования реализации паттерна Сага**

~~Паттерн сага используется для обеспечения согласованности при транзакциях между несколькими сервисами.~~

Если у вас есть транзакция, которая охватывает несколько сервисов, то вы можете воспользоваться встроенной реализацией паттерна Сага.

Взаимодейсвие с Сагами выполняются с использованием `SagaManager`. По умолчанию все инструменты для взаимодействия с Сагами включены, но если вы хотите сделать свою реализацию, то в конфигурации можно выключить встроенную реализацию паттерна Сага: `event.sourcing.sagas-enabled=false`

Для того, чтобы запустить Cагу нужно создать шаг Саги. Сделать это можно с помощью вызова метод `launchSaga` у `SagaManager`, передав `sagaName` - название этого процесса и `stepName` - название текущего шага. И после выполнения этого метода получить `sagaContext` - результат выполнения шага Саги и передать его при обновлении агрегата.
*Code...*

Для локального хранения информации о Сагах, используется агрегат `SagaStepAggregate`.
У этого агрегата есть 4 ивента:
- `launchSagaStep` - информирует о том, что был **инициирован** первый шаг Саги, но он ещё не был обработан.
- `initiateSagaStep` - информирует о том, что был **инициирован** последующий шаг Саги, но он ещё не был обработан.
- `processSagaStep` - информирует о том, что шаг Саги был **обработан** и сохранён в `EventStore`.
- `processMinSaga` - информирует о том, что шаг Саги по умолчанию был обработан.

Все эти события сохраняются в таблицу `sagas`.

Чтобы другие сервисы могли продолжить Сагу им нужно знать `sagaName` и подписаться на соответствующий ивент.
Для того, чтобы передать информацию о `sagaContext` предыдущего ивента, необходимо вызвать у `SagaContext` метод `withContextGiven`, передав туда этот `sagaContext`. После этого уже можно вызвать метод `performSagaStep` передав туда, также, как и в  `метод launchSaga` - `sagaName` и `stepName`.
*Code...*

Если в вашей бизнес логике необходимо, чтобы Сага исполнялась не только последовательно, а ещё и **параллельно**, т.е. когда для продолжения какого-то шага необходимо дождаться завершения несколько предыдущих, то вы можете передать в метод `witchContextGiven` несколько `sagaContext` путём их складывания:
*Code...*

Если вам необходимо обособить несколько шагов внутри одной Саги, т.е. создать **вложенную Сагу**, то вы можете сделать это следующим образом:
*Code...*
В таком случае будет создано две Саги, основная будет включать все шаги, а вложенная только подшаги.

Как известно, если одна из транзакций Саги завершилась неудачей, то необходимо запустить логику **компенсирующих транзакций** для сохранения согласованности в системе. В библиотеке компенсирующие транзакции задаются также, как и обычные. Т.е. в случае ошибки, необходимо создать ивент, на основе которого будут действовать сервисы, которые были предыдущими в цепочке транзакций.

Также есть возможность использовать более **упрощённую схему** использования паттерна Сага, без `SagaManager`. Тогда у Саги и её шагов не будет названий. Для этого при обновлении агрегата достаточно передать `SagaContext` предыдущего ивента:
*Code...*
При таком способе использования паттерна нельзя будет создавать вложенные Саги и параллельные шаги, а также отслеживать время обработки каждого шага.

Для отслеживания Саг можно воспользоваться готовым сервисом из модуля `tiny-event-sourcing-sagas-projections`.
Этот сервис подписывается на события локальных агрегатов саг `SagaStepAggregate` и создаёт таблицы `sagas-projections` для расширенного варианта и `sagas-min-projections` для упрощённого. С помощью этого сервиса можно в одном месте отследить все Саги, которые есть в системе.
*Example...*
Здесь для каждой Саги создаётся свой документ, где отображается id, sagaName и все шаги этой Саги. В sagaSteps помимо stepId, prevStepsId и stepName есть время, когда начался процесс обработки шага, и когда он уже был успешно завершён, а также название ивента, к которому относиться этот шаг. Всю последовательность шагов можно отследить по stepId и prevStepsId.

Если вам нужно создать свой сервис для отслеживания Саг, то вы можете сделать это по примеру этого готового сервиса.
